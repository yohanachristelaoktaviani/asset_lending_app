<% provide(:title, "Loan & Return Items") %>
<div class="form">
  <br>
  <div class="container9 mb-5">
  <h1>Loan & Return Items</h1>

  <% if flash[:success] %>
  <div class="alert alert-success">
    <%= flash[:success] %>
  </div>
  <% end %>

  <% if flash[:errors] %>
  <div class="alert alert-danger">
    <%= flash[:errors] %>
  </div>
  <% end %>


  <div class="table-responsive w-100 mb-5">
<table class="table borderless w-100 mb-5">
  <tr>
  <td><%= button_to new_user_asset_loan_path, method: 'get', class: "button2 btn btn-primary", style: "width: 50%;" do %>
    <span class="fa-solid fa-plus" aria-hidden="true"></span>
    New Loan
  <% end %>
  </td>
  <td>
    <div class="table-container">
      <%= form_tag user_asset_loans_path, method: 'get' do %>
         <div class="input-group mx-1 search">
            <%= text_field_tag :search, params[:search], placeholder: 'Type here...', class: "form-control search-box" %>
            <span class="input-group-btn">
              <%= button_tag(type: "submit", class: "btn btn-secondary search-button") do %>
                <i class="fa fa-search"></i>
              <% end %>
            </span>
            </div>
      <% end %>
    </td>
  </tr>
</table>

  <table class="table table-bordered w-100 center">
    <thead class="thead">
      <tr>
        <th onclick="sortTable(0)" class="th vcenter text-nowrap">Code <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(1)" class="th vcenter text-nowrap">Item Name <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(2)" class="th vcenter text-nowrap">Loan Datetime <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(3)" class="th vcenter text-nowrap">Return Estimation Datetime <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(3)" class="th vcenter text-nowrap">Actual Return Datetime <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(4)" class="th vcenter text-nowrap">Item Condition <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(4)" class="th vcenter text-nowrap">Necessary <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(5)" class="th vcenter text-nowrap">Admin <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(6)" class="th vcenter text-nowrap">Loan Status <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(7)" class="th vcenter text-nowrap">Reason <i class="fa fa-fw fa-sort"></th>
        <th onclick="sortTable(8)" class="th vcenter text-nowrap">Return Status <i class="fa fa-fw fa-sort"></th>
      </tr>
    </thead>
    <tbody>
        <% grouped_asset_loans = @loan_items.group_by { |asset| asset.asset_loan.code } %>
        <% grouped_asset_loans.each do |loan_code, assets| %>
          <% rowspan = assets.size %>
          <% assets.each_with_index do |asset, index| %>
        <tr>
            <td style="text-align:left"><%= link_to loan.asset_loan.code, user_asset_loan_path(loan.asset_loan.id) %></td>
            <td><%= loan.item.name %></td>
            <td><%= loan.asset_loan.loan_item_datetime.strftime("%Y-%m-%d %H:%M:%S") %></td>
            <td><%= loan.asset_loan.return_estimation_datetime.strftime("%Y-%m-%d %H:%M:%S") %></td>
            <td>
              <% actual_return_datetime = AssetReturn.where(asset_loan_id: asset.asset_loan_id).pluck(:actual_return_datetime).first %>
              <%= actual_return_datetime.strftime("%Y-%m-%d %H:%M:%S") if actual_return_datetime %>
            <td>
              <% if asset.item.condition == "layak pakai" %>
                <span class="badge rounded-pill bg-success"><%= asset.item.condition %></span>
              <% elsif asset.item.condition == "layak pakai ada cacat" %>
                <span class="badge rounded-pill bg-warning"><%= asset.item.condition %></span>
              <% elsif asset.item.condition == "tidak layak pakai" %>
                <span class="badge rounded-pill bg-danger"><%= asset.item.condition %></span>
            <% end %>
            </td>
            <td><%= loan.asset_loan.necessary %></td>
            <td>
              <%= if loan.admin.present?
                    loan.admin.name
                  else
                    ""
                  end
              %>
            </td>
            <td>
              <% if loan.loan_status == "accepted" %>
                  <span class="badge rounded-pill bg-success"><%= loan.loan_status %></span>
                <% elsif loan.loan_status == "decline" %>
                  <span class="badge rounded-pill bg-danger"><%= loan.loan_status %></span>
                <% elsif loan.loan_status == "waiting" %>
                  <span class="badge rounded-pill bg-warning"><%= loan.loan_status %></span>
                <% elsif loan.loan_status == "cancel" %>
                  <span class="badge rounded-pill bg-secondary"><%= loan.loan_status %></span>
                <% end %>
            </td>
            <td><%= asset.evidence %></td>
            <td>
              <% return_status = AssetReturn.where(asset_loan_id: asset.asset_loan_id).pluck(:return_status).first %>
              <% if return_status == "on time" %>
                <span class="badge rounded-pill bg-success"><%= return_status %></span>
              <% elsif return_status == "early" %>
                <span class="badge rounded-pill bg-info"><%= return_status %></span>
              <% elsif return_status == "late" %>
                <span class="badge rounded-pill bg-danger"><%= return_status %></span>
              <% end %>
            </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <br>
</div>
<%= paginate @loan_items, :window => 3 %>
</div>
</div>
</div>